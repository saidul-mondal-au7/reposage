scan_repository:
  name: scan_repository
  description: >
    You must:
    1. Call clone_repo(repo)
    2. Call scan_repository(repo_path)
    3. Call classify_files(files)
    4. Call detect_languages(files)

    Then MERGE all outputs into ONE JSON object with exactly these keys:
    - repo_path
    - total_files_scanned
    - main_directories
    - detected_languages
    - entry_points
    - config_files
    - dependency_files

    Structured JSON matching ScanRepositoryOutput schema

  inputs:
    repo: "{{ repo }}"

  agent: code_scanner


analyze_architecture:
  name: analyze_architecture
  description: >
    You are given the repository scan output below:

    {{ scan_repository }}

    Based ONLY on this data:
    - Identify architecture type (monolith, modular monolith, microservices)
    - Identify key modules or domains
    - Identify service or module interactions
    - Identify design patterns
    - Describe runtime execution flow

    Return ONLY structured JSON.

  expected_output: >
    JSON with:
    - architecture_type
    - key_modules
    - service_interactions
    - detected_design_patterns
    - runtime_flow_summary

  agent: architecture_analyst
  depends_on:
    - scan_repository


security_analysis:
  name: security_analysis
  description: >
    You are given the repository scan output:

    {{ scan_repository }}

    Analyze the repository to identify:
    - Hardcoded secrets
    - Insecure configuration
    - Weak authentication or authorization
    - Unsafe or exposed endpoints
    - OWASP Top 10 vulnerability patterns

    Use tools when applicable.
    Return ONLY structured JSON.

  expected_output: >
    JSON with:
    - issues:
        - issue
        - severity
        - affected_files
        - recommended_fix

  agent: security_analyst
  depends_on:
    - scan_repository


performance_analysis:
  name: performance_analysis
  description: >
    You are given the repository scan output:

    {{ scan_repository }}

    Identify performance and scalability risks:
    - N+1 query patterns
    - Blocking or synchronous I/O
    - Missing pagination
    - Inefficient data access
    - Scalability bottlenecks

    Use tools when applicable.
    Return ONLY structured JSON.

  expected_output: >
    JSON with:
    - issues:
        - issue
        - severity
        - affected_file
        - likely_symptoms
        - recommended_fix

  agent: performance_analyst
  depends_on:
    - scan_repository


plan_roadmap:
  name: plan_roadmap
  description: >
    You are given the following analyses:

    Architecture:
    {{ analyze_architecture }}

    Security:
    {{ security_analysis }}

    Performance:
    {{ performance_analysis }}

    Create a prioritized engineering roadmap with:
    - Immediate fixes (P0)
    - Short-term improvements (P1)
    - Medium-term initiatives (P2)

    Each item MUST include:
    - priority
    - task
    - impact
    - effort
    - risk
    - justification

    Return ONLY structured JSON.

  expected_output: >
    JSON with:
    - immediate_fixes
    - short_term
    - medium_term

  agent: roadmap_planner
  depends_on:
    - analyze_architecture
    - security_analysis
    - performance_analysis
